## 《看房笔记》PWA 完整 PRD（v1.0 可开发稿）

> 范围：PWA（手机优先），支持离线、本地存储；房源录入（照片/速记/重点项勾选与打分/自定义维度）+ 列表对比（筛选/排序）+ 权重总分（拖动权重、默认权重）。
> 非范围：账号体系/云同步/多人共享/平台房源抓取（后续版本）。

---

# 0. 产品定义

## 0.1 目标

* **现场录入 ≤ 60 秒/套**（拍照+速记+重点项）
* **晚上对比 ≤ 5 分钟**筛出 Top3
* 支持用户自定义维度（全局生效）
* 支持权重调参后立即改变排序

## 0.2 核心理念

* **先记录再计算再调参**：首次使用不强制设置，默认可用
* **结构化信息防混**：照片/重点项按固定结构采集
* **可解释的总分**：总分由维度×权重计算，支持查看贡献

---

# 1. 产品结构（信息架构）

## 1.1 页面清单

1. **首页-房源列表**（/list）
2. **新建/编辑房源**（/edit/:id?）
3. **房源详情**（/detail/:id）
4. **对比页**（/compare?ids=）
5. **筛选面板**（Drawer，列表页内）
6. **权重设置**（/weights）
7. **维度管理**（/dimensions）
8. **设置**（/settings）
9. **导出/备份**（/export）

## 1.2 导航模式（手机）

* 底部 Tab（3个）：

  * 房源
  * 对比
  * 设置
* 右上角：快速入口（权重、维度管理）

---

# 2. 数据模型（可直接落库）

## 2.1 核心对象

### Home（用户全局配置）

* `workLocations: [{id,name,address,lat,lng}]`（至少1个：公司）
* `activeWorkLocationId`
* `unitSystem`（可选）
* `scoreProfileId`（当前使用的权重方案）
* `defaultVisibleDimensions: string[]`（默认展示维度集合）

### Visit（房源）

* `id`
* `indexNo`（自增字符串：01,02...）
* `createdAt`
* `updatedAt`
* `title`（默认：“房源 12”，可改）
* `community`（小区/地址文本）
* `geo?: {lat,lng,accuracy}`（可选）
* `rent?: number`（元/月）
* `deposit?: string`（押一付一等）
* `area?: number`（㎡）
* `floor?: number`
* `totalFloor?: number`
* `orientation?: string[]`（S/N/E/W/南北通透）
* `status`（`none|candidate|rejected`）
* `quickNoteText?: string`
* `voiceMemos: VoiceMemo[]`
* `photos: Photo[]`（按分类）
* `values: Record<dimensionId, DimensionValue>`（维度值）
* `computed: { totalScore?: number, breakdown?: ScoreBreakdown }`

### Photo

* `id`
* `category`（见 3.2）
* `blobPath`
* `thumbBlobPath`
* `createdAt`

### VoiceMemo

* `id`
* `audioBlobPath`
* `durationMs`
* `createdAt`
* `transcriptText?`（可选）

### Dimension（维度定义，全局）

* `id`
* `name`
* `group`（subjective/commute/cost/facility/risk/custom）
* `type`（rating|boolean|select|number|text）
* `scoring`（如何转成0–100，见 6）
* `defaultEnabled`
* `defaultWeight`
* `defaultVisible`
* `options?`（select 类型的选项）
* `helpText?`（录入提示）

### ScoreProfile（权重方案）

* `id`
* `name`（默认：均衡）
* `weights: Record<dimensionId, number>`（0–100）
* `enabled: Record<dimensionId, boolean>`
* `updatedAt`

---

# 3. 维度库（默认“尽量全”）与录入方式

> 维度分为：**评分（0–10）**、**是/否**、**选择（枚举）**、**数值（分钟/元/米）**。
> 每个维度都有：录入提示、交互、选项、评分映射规则（见第6章）。

## 3.1 默认展示（新手精简组，录入页默认展开）

**评分（0–10，滑杆）**

1. 采光（light）
2. 噪音（noise）
3. 潮湿/异味（damp_smell）
4. 空间舒适/压抑（space_comfort）
5. 装修维护（condition）

**数值**
6. 租金（rent，元/月）
7. 通勤（commute_min，分钟；v1 允许手填，v1.1 接地图）

**是/否**
8. 可做饭（cookable）
9. 有电梯（elevator）

> 以上 9 项构成默认总分的主要输入，保证开箱可排序。

## 3.2 照片分类（固定结构，防混）

必备分类（每类≥1张建议，但不强制）：

* 客厅
* 卧室
* 厨房
* 卫生间
* 窗外/阳台/采光

可选分类：

* 入户/门锁
* 小区环境/楼道
* 设备铭牌（热水器/空调）

## 3.3 全量维度库（默认内置，可在维度管理启用/隐藏）

### A 主观体验（subjective）

* 采光（rating 0–10）
* 噪音（rating）
* 潮湿/异味（rating）
* 空间舒适/压抑（rating）
* 通风（rating）
* 隐私（rating）
* 收纳（rating）
* 隔音主观（select：好/一般/差）
* 采光遮挡（boolean）
* 视野（rating）

### B 通勤与位置（commute）

* 到公司通勤分钟（number minutes）
* 通勤方式（select：地铁/公交/步行/骑行/驾车/混合）
* 最近地铁站步行分钟（number）
* 生活便利度（rating 或 number 0–100；v1 可手填，v2 自动算）
* 3km 商场数量（number）
* 3km 超市数量（number）
* 3km 医院数量（number）
* 3km 公园数量（number)

> v1：可先把“周边配套”作为手填/不启用项；结构先预埋。

### C 成本条款（cost）

* 租金（number）
* 押付方式（select：押一付一/押一付三/半年付/年付/其他）
* 中介费（number，可空）
* 水电类型（select：民水民电/商水商电/不清楚）
* 物业费（number，可空）
* 合同期限（月）（number）
* 押金条款清晰（select：清晰/模糊/不清楚）

### D 设施条件（facility）

* 有电梯（boolean）
* 空调数量（number）
* 热水器类型（select：燃气/电/集中/不清楚）
* 洗衣机（boolean）
* 冰箱（boolean）
* 网络（select：已装/可装/不清楚）
* 车位（select：固定/临停/无/不清楚）
* 可养宠（select：可/不可/不清楚）
* 门禁安全感（rating）

### E 风险提示（risk）

* 墙角/窗框霉点（boolean）
* 主干道噪音风险（boolean）
* 低楼层潮湿风险（boolean）
* 电路/插座老旧担忧（select：无/有点/明显）
* 房东/中介靠谱度（select：好/一般/差）

### F 自定义（custom）

* 用户可新增：boolean/rating/number/select/text

---

# 4. 页面与交互（逐页到元素级）

## 4.1 首页-房源列表（/list）

### 布局

* 顶部栏：标题「看房笔记」

  * 右侧图标：搜索（可选 v1.1）、权重、维度
* 下方：排序按钮 + 筛选按钮
* 主区域：房源卡片列表
* 底部固定主按钮：`+ 记录一套房`

### 房源卡片元素

* 左：封面缩略图（无则占位）
* 右上：总分（大号）+ 贡献提示（小号：通勤/租金等）
* 标题：`{indexNo} {community或title}`
* 次行：租金、通勤、楼层朝向（有则显示）
* 标签（最多3个）：来自“低分/高分项”自动生成（规则见 6.6）
* 右下：⭐候选、🗑删除（滑动也可）

### 操作

* 点卡片 → 详情页
* 长按 → 进入多选（用于对比）
* 排序：总分/创建时间/租金/通勤
* 筛选：打开 Drawer（见 4.5）

---

## 4.2 新建/编辑房源（/edit/:id?）

### 顶部

* 返回
* 标题：新建/编辑
* 右侧：保存（v1 可省略，采用自动保存；保留“完成”按钮）

### 内容分区（从上到下）

1. **基础信息（折叠块，默认折叠，仅显示小区/租金）**

   * 小区/地址（输入）
   * 租金（数字）
   * 面积、楼层、朝向（展开后）
   * 状态：候选/淘汰/未标记（按钮组）

2. **照片（固定结构）**

   * 5 个分类卡片，每个卡片：

     * 标题 + 已拍数量
     * 按钮：拍照 / 选照片
     * 缩略图横滑预览
   * 交互要求：

     * 拍完自动归类
     * 删除单张：长按缩略图 → 删除

3. **速记（打字/语音二选一也可都用）**

   * Tab：打字 | 语音（默认记住上次选择）
   * 打字：单行输入 + 可展开多行
   * 语音：录音按钮 + 录音列表（播放/删除）

4. **重点项（默认“精简组”）**

   * 显示 9 项（见 3.1）
   * 每项有 `i` 提示（如何打分/参考标准）
   * 底部：`展开全部维度`（进入全量维度录入）

5. **全部维度（展开后）**

   * 分组展示（主观/通勤/成本/设施/风险/自定义）
   * 每项输入控件按类型渲染（见 5）

### 自动保存规则（必须）

* 任意字段变更 300ms debounce 后落盘
* 拍照/录音结束立即落盘
* 离开页面不弹窗确认（减少干扰）

---

## 4.3 房源详情（/detail/:id）

> v1 可与编辑页合并：默认“查看模式”，右上“编辑”。

### 布局

* 顶部：封面大图（客厅）+ 返回 + 编辑
* 信息摘要条：总分、通勤、租金、状态
* Tabs（可选）：概览 | 维度 | 照片 | 速记

  * v1 可直接纵向一页滚动，减少实现量

### 解释总分（重要）

* 显示 “总分 = xx”
* 可展开“分数贡献 Top5”：

  * 通勤：+18
  * 租金：+12
  * 采光：+10
  * ……

---

## 4.4 对比页（/compare）

### 入口

* 列表多选 → “对比(2–6)”
* 或 Tab「对比」默认展示“候选”集合

### 展示

* 顶部：筛选 + 排序（与列表一致）
* 表格/卡片两种视图（v1 做表格）
* 每行一套房；列可横滑：

  * 总分、通勤、租金、采光、噪音、潮湿、可做饭、电梯、车位、备注摘要…
* 支持“固定列”：编号/封面/总分固定

### 操作

* 勾选加入候选⭐（Top3）
* 点击某格 → 跳详情定位到该维度

---

## 4.5 筛选面板（列表/对比共用 Drawer）

筛选项（v1 必做）

* 状态：全部/候选/淘汰/未标记
* 租金区间：min/max
* 通勤区间：min/max
* 必须条件（多选）：

  * 可做饭=是
  * 有电梯=是
  * 可养宠=可（若启用）
* 清空 / 应用

---

## 4.6 权重设置（/weights）—“拖动权重”

### 目标交互

用户不用“选一个”，而是**拖动权重表达偏好**；排序实时变化。

### 页面布局

1. 顶部：当前方案名称（均衡默认）+ “另存为”
2. 权重列表（每行一个维度）：

   * 左：维度名 + 开关（启用/禁用）
   * 中：权重条（可拖动）
   * 右：数值（0–100）
3. 底部固定栏：

   * “归一化到100”（一键）
   * “重置默认”
   * “预设：均衡/通勤更重/省钱更重/舒适更重/有车族”

### 权重拖动的明确规则（必须写死）

* 权重范围：0–100
* 默认总和目标：100（展示在顶部）
* 拖动某项时：

  * v1 简化：只改该项数值，顶部总和随之变化；用户可点“一键归一化”
  * v1.1 优化：保持总和=100，拖高某项时其他启用项按比例缩小

---

## 4.7 维度管理（/dimensions）

### 功能

* 启用/禁用维度（是否参与录入和计算）
* 控制默认展示（录入页精简组）
* 新建自定义维度（全局生效）
* 编辑自定义维度（名称/类型/选项/默认权重/分组）
* 删除自定义维度（两种删除方式）

### 新建自定义维度交互（明确字段）

* 名称（必填）
* 类型（单选）：是/否、0–10评分、数字、选择、文本
* 分组（默认 custom）
* 选择类型时：配置选项（每行一个）
* 是否参与总分（默认否，可开启）
* 默认权重（若参与总分，默认10）
* 默认展示（是/否）

---

## 4.8 设置（/settings）

* 公司地点（文本即可 v1；v1.1 加地图选点）
* 通勤方式偏好（默认地铁/驾车）
* 定位开关（记录经纬度）
* 数据存储占用（只显示）
* 导出入口

## 4.9 导出（/export）

* 导出 JSON（包含房源、维度、权重方案）
* 导出 CSV（可选：只导出关键字段）

---

# 5. 录入控件规范（每个类型怎么交互）

## 5.1 rating（0–10）

* 控件：滑杆（0–10）+ 快速点击刻度
* 默认值：空（未填写），不参与计算（或按中位数处理；v1建议“不参与”）
* 提示：显示 3 个锚点描述（0/5/10）

示例（采光）：

* 0：白天也很暗
* 5：正常，需开灯
* 10：通透明亮

## 5.2 boolean（是/否/不清楚）

* 控件：三态按钮组：是 / 否 / 不清楚（默认不清楚）
* 参与计算时映射（见 6.2）：是=100，否=0，不清楚=50（可配置）

## 5.3 select（枚举）

* 控件：底部弹出选择器
* 允许“不清楚”
* 每个选项可配置分值（如“水电类型：民水民电>商水商电”）

## 5.4 number（数值）

* 控件：数字输入 + 单位（分钟/元/㎡/米）
* 可提供快速步进按钮（-5/+5分钟）
* 对“越小越好”的数值（通勤/租金）需归一化（见 6.3）

## 5.5 text（文本）

* 控件：多行输入，支持快速短语（可后续）

---

# 6. 评分与总分（非常明确）

## 6.1 维度得分统一到 0–100

### rating

`score = value/10 * 100`

### boolean（三态）

* 是：100
* 否：0
* 不清楚：50（默认；可在维度定义里改为“不参与”）

### select

为每个选项定义一个固定分值（0–100）。示例：

* 水电类型：民水民电=100，商水商电=30，不清楚=50
* 车位：固定=100，临停=60，无=0，不清楚=50

### number（数值归一化）

两类：

1. **越小越好**（通勤分钟、租金）

* 需要用户提供“可接受范围”，v1 采用简单策略：

  * 设默认区间：

    * 通勤：`best=20min, worst=90min`
    * 租金：`best=预算下限, worst=预算上限`（若用户没填预算，用样本分位数替代：P20/P80）
* 计算：

  * `clamped = clamp(value, best, worst)`
  * `score = (worst - clamped) / (worst - best) * 100`

2. **越大越好**（面积）

* `score = (clamped - worst) / (best - worst) * 100`

> v1 为了可落地：可先只对“通勤、租金”做归一化，其余 number 默认不参与总分，除非用户启用。

## 6.2 总分公式（启用项）

`total = Σ(score_i * weight_i) / Σ(weight_i)`

* 仅计算 enabled=true 且值不为空（或不清楚按规则处理）
* 结果四舍五入到整数（0–100）

## 6.3 默认权重（均衡默认）

启用项与权重（总和100）：

* 通勤分钟：25
* 租金：20
* 采光：15
* 噪音：15
* 潮湿/异味：15
* 装修维护：10

## 6.4 标签生成规则（列表展示用）

从启用维度里挑选：

* 分数 ≥ 80 的前2项 → 正向标签（如“采光好”“通勤短”）
* 分数 ≤ 30 的前1项 → 风险标签（如“潮湿风险”“噪音大”）

## 6.5 总分解释（详情页 breakdown）

显示贡献值：

* `contrib_i = (score_i * weight_i) / Σ(weight)`
  排序取 Top5 展示。

## 6.6 如何指导用户“怎么打分/怎么描述”

每个默认维度都提供 `helpText`（UI里点 i 展示）。示例：

* 噪音：

  * 0：明显车流/施工/隔壁吵
  * 5：偶尔能听到但可接受
  * 10：几乎安静
* 潮湿/异味：

  * 0：霉味/烟味明显
  * 5：轻微但可接受
  * 10：无异味、干爽
* 空间舒适：

  * 0：压抑、拥挤
  * 5：正常
  * 10：通透、动线舒服

速记建议（占位提示）：

* “一句话：最喜欢/最担心的各1点”

  * 例：`采光很好，但窗框有霉点，担心潮湿`

---

# 7. 用户用例（Use Cases）与验收

## UC1：首次使用直接记录

**前置**：无设置
**步骤**：

1. 打开 PWA → 首页 → 点「+记录一套房」
2. 拍客厅/卧室各1张
3. 打字一句第一印象
4. 调整采光/噪音/潮湿评分
5. 返回列表
   **期望**：

* 列表出现新房源卡片，带缩略图、总分（若部分维度未填仍可计算或显示“待完善”）
* 重启后数据仍在

## UC2：一天记录30套不混

**步骤**：连续新增30套，每套5张图+至少3项评分
**期望**：

* 列表滚动不卡顿（缩略图懒加载）
* 任意房源点开能快速看到对应照片分类
* 无“照片混到别的房”情况

## UC3：对比筛选并排序

**步骤**：

1. 打开筛选：通勤≤45、租金≤6000、可做饭=是
2. 排序：按总分
3. 选 Top3 标⭐
   **期望**：筛选结果正确，排序稳定，候选状态在列表/对比页一致。

## UC4：调整权重，排序立即变化

**步骤**：

1. 权重页把“通勤”从25拖到40
2. 点击归一化
3. 返回列表
   **期望**：总分及排序发生变化；详情页 breakdown 同步更新。

## UC5：新增自定义维度全局生效

**步骤**：

1. 维度管理 → 新建 “可装洗碗机”（boolean）
2. 回到任意房源录入页能看到该项
3. 在多套房里填写不同值
4. 启用该维度并设置权重
   **期望**：所有房源出现该项；参与总分后排序变化。

---

# 8. 边界与异常处理（必须明确）

* 未填维度：默认不参与总分（避免乱算）；详情页提示“完善后更准”
* 三态“不清楚”：默认按 50 分参与（可在维度定义里改为不参与）
* 删除维度：

  * 默认仅隐藏，不删除历史值（可恢复）
  * 若选择“彻底删除”，需要二次确认
* 删除房源：二次确认，删除照片/音频Blob
* 存储占用：提示“建议导出备份后清理”
* 离线：所有核心功能可用；地图计算若依赖网络则显示“暂不可用，可手填分钟”

---

# 9. PWA 与性能要求（实现约束）

* IndexedDB 存：Visit JSON、Dimension、ScoreProfile、照片Blob、音频Blob
* 生成缩略图：拍照后立刻生成 thumb，用于列表
* 列表只加载 thumb；详情才加载原图
* Service Worker：缓存静态资源（离线打开）
* 自动保存：输入即存，避免 iOS 后台回收导致丢失

---

# 10. 里程碑拆分（建议实现顺序）

* M1：房源CRUD + 照片分类 + 速记（打字+语音）+ 默认维度录入
* M2：总分计算 + 列表排序 + 筛选
* M3：权重设置（拖动+归一化）+ 贡献解释
* M4：维度管理 + 自定义维度
* M5：导出/备份 + 存储占用提示

